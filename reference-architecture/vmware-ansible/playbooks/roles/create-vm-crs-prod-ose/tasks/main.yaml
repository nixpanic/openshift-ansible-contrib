---
- name: Define DHCP network parameters per node
  set_fact:
    network_parameters: "{{ network_parameters | default({}) |
                            combine({item.value.guestname: {
                                'name': vm_network,
                                'type': vm_ipaddr_allocation_type,
                                'gateway': vm_gw}}, recursive=True) }}"
  with_dict: "{{ host_inventory }}"
  when: "item.value.guesttype in ['crs', ]"

- name: Define static network parameters per node
  set_fact:
    network_parameters: "{{ network_parameters |
                            combine({item.value.guestname: {
                                'ip': item.value.ip4addr,
                                'netmask': vm_netmask}}, recursive=True) }}"
  with_dict: "{{ host_inventory }}"
  when:
  - "'static' == vm_ipaddr_allocation_type"
  - "item.value.guesttype in ['crs', ]"

- name: Define set of main disks (system and heketi)
  set_fact:
    disks_info: "{{ disks_info | default([
                     {'size_gb': 60, 'type': 'thin', 'datastore': vcenter_datastore},
                     {'size_gb': 40, 'type': 'thin', 'datastore': vcenter_datastore},
                     {'size_gb': 40, 'type': 'thin', 'datastore': vcenter_datastore}])
                 }} + {{
                    [{'size_gb': (item.strip() | int),
                      'type': container_storage_disk_type,
                      'datastore': vcenter_datastore}]
                 }}"
  with_items: "{{ container_storage_disks.split(',') }}"

- name: Define set of additional disks which will be just attached to nodes
  set_fact:
    additional_disks_info: "{{ additional_disks_info | default([]) }} + {{
                               [{'size_gb': (item.strip() | int),
                                 'type': container_storage_disk_type,
                                 'datastore': vcenter_datastore}]
                            }}"
  with_items: "{{ additional_disks_to_storage_nodes.split(',') }}"

- name: Create CRS production VMs on vCenter
  vmware_guest:
    hostname: "{{ vcenter_host }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: False
    name: "{{ item.value.guestname }}"
    cluster: "{{ vcenter_cluster}}"
    datacenter: "{{ vcenter_datacenter }}"
    resource_pool: "{{ vcenter_resource_pool }}"
    template: "{{vcenter_template_name}}"
    state: poweredon
    wait_for_ip_address: true
    folder: "/{{ vcenter_folder }}"
    annotation: "{{ cluster_id }}-crs"
    disk: "{{ disks_info }} + {{ additional_disks_info }}"
    hardware:
      memory_mb: 32768
    networks: "[ {{ network_parameters[item.value.guestname] }} ]"
    customization:
      domain: "{{dns_zone}}"
      dns_servers:
      - "{{ vm_dns }}"
      dns_suffix: "{{dns_zone}}"
      hostname: "{{ item.value.guestname}}"
  with_dict: "{{host_inventory}}"
  when: "item.value.guesttype in ['crs', ]"
  register: facts

- name: Map node names and their IP addresses
  set_fact:
    ip4addrs: "{{ ip4addrs | default({}) | combine(
                      {item.item.value.guestname: (
                           item.instance.hw_eth0.ipaddresses | ipv4 | first)},
                      recursive=True) }}"
  with_items: "{{ facts.results }}"
  when: "item.item.value.guesttype in ['crs', ]"

- name: Define glusterfs devices
  set_fact:
    glusterfs_devices: "{{ glusterfs_devices | default([]) }} +
                        {{ ['/dev/sd' + 'defghijklmnopqrstuvwxyz'[item.0]] }}"
  with_indexed_items: disks_info

- name: Add CRS production VMs to inventory
  add_host:
    hostname: "{{ item.value.guestname }}"
    ansible_fqdn: "{{ item.value.guestname }}.{{ dns_zone }}"
    ansible_ssh_host: "{{ ip4addrs[item.value.guestname] }}"
    # old groups are: crs, production_group, {{cluster-id}}-crs
    groups: "{{ cluster_id }}-crs, crs, storage, glusterfs"
    # Following vars are for 'openshift_storage_glusterfs' role from
    # 'openshift/openshift-ansible' repo
    glusterfs_devices: "{{ glusterfs_devices }}"
    glusterfs_hostname: "{{ item.value.guestname }}"
    glusterfs_ip: "{{ ip4addrs[item.value.guestname] }}"
    glusterfs_zone: "{{ ip4addrs[item.value.guestname].split('.')[-2::] | join('') | int }}"
  with_dict: "{{ host_inventory }}"
  when: "item.value.guesttype in ['crs', ]"
